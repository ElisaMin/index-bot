# This workflow will build a Java project with Gradle
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-gradle

name: Java CI with Gradle

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: "17"
          distribution: "adopt"

      # 下载资源文件
      - name: Download resource
        run: |
          mkdir resource
          cd resource
          curl -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-1.17.10-linux-x86_64.tar.gz
          curl -L https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v1.17.10/elasticsearch-analysis-ik-1.17.10.zip > elasticsearch-analysis-ik-1.17.10.zip
          wget https://download.java.net/java/GA/jdk17.0.2/dfd4a8d0985749f896bed50d7138ee7f/8/GPL/openjdk-17.0.2_linux-x64_bin.tar.gz --no-check-certificate -O ./openjdk-17.0.2_linux-x64_bin.tar.gz
          ls

      - name: Build with Gradle
        run: |
          cd index-bot
          chmod +x gradlew
          ./gradlew bootJar

      - name: RPM Ready
        run: |
          rm -rf ~/rpmbuild
          mkdir -pv ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}

      - name: Move files
        run: |
          mkdir -p ~/rpmbuild/BUILD/bot
          mv package/config ~/rpmbuild/BUILD/
          mv package/lang ~/rpmbuild/BUILD/bot/
          mv package/data ~/rpmbuild/BUILD/bot/
          mv index-bot/build/libs/telegram-index-bot-2.0.0-next.jar ~/rpmbuild/BUILD/bot/
          mv index-bot/src/main/resources/application.yaml ~/rpmbuild/BUILD/bot/

          mv resource/elasticsearch-1.17.10-linux-x86_64.tar.gz ~/rpmbuild/BUILD/
          mv resource/elasticsearch-analysis-ik-1.17.10.zip ~/rpmbuild/BUILD/
          mv resource/openjdk-17.0.2_linux-x64_bin.tar.gz ~/rpmbuild/BUILD/

          mv package/index-bot-elasticsearch.service ~/rpmbuild/BUILD/
          mv package/index-bot.service ~/rpmbuild/BUILD/

          mv package/ReadMe.md ~/rpmbuild/BUILD/
          mv package/build.spec ~/rpmbuild/SPECS/

          echo "~/rpmbuild/BUILD/"
          ls ~/rpmbuild/BUILD/
          echo "~/rpmbuild/BUILD/bot"
          ls ~/rpmbuild/BUILD/bot

      - name: RPM Build
        run: |
          rpmbuild -bb ~/rpmbuild/SPECS/build.spec
          ls ~/rpmbuild/RPMS/x86_64

      - name: Publish artifacts
        uses: actions/upload-artifact@v2
        with:
          name: telegram-index-bot
          path: ~/rpmbuild/RPMS/x86_64/*
